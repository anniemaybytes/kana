---
kind: pipeline
name: node-v10
type: docker

platform:
    os: linux
    arch: amd64

steps:
    -   name: restore-cache
        image: meltwater/drone-cache
        failure: ignore
        environment:
            AWS_ACCESS_KEY_ID:
                from_secret: aws_access_key_id
            AWS_SECRET_ACCESS_KEY:
                from_secret: aws_secret_access_key
            PLUGIN_PATH_STYLE: true
        settings:
            endpoint:
                from_secret: aws_endpoint
            region: ab-1
            bucket: drone-cache
            restore: true
            cache_key: '{{ checksum "package.json" }}_{{ checksum "package-lock.json" }}_node-v10'
            archive_format: gzip
            mount:
                - ./node_modules
                - ./hubot-irc/node_modules
        depends_on: [ clone ]
    -   name: install
        image: node:10
        commands:
            - node -v
            - npm -v
            - npm i --no-save --quiet --no-optional
        depends_on: [ restore-cache ]
    -   name: tests
        image: node:10
        commands:
            - npm run test
        depends_on: [ install ]
    -   name: linter
        image: node:10
        commands:
            - npm run lint
        depends_on: [ install ]
    -   name: rebuild-cache
        image: meltwater/drone-cache
        failure: ignore
        environment:
            AWS_ACCESS_KEY_ID:
                from_secret: aws_access_key_id
            AWS_SECRET_ACCESS_KEY:
                from_secret: aws_secret_access_key
            PLUGIN_PATH_STYLE: true
        settings:
            endpoint:
                from_secret: aws_endpoint
            region: ab-1
            bucket: drone-cache
            rebuild: true
            cache_key: '{{ checksum "package.json" }}_{{ checksum "package-lock.json" }}_node-v10'
            archive_format: gzip
            mount:
                - ./node_modules
                - ./hubot-irc/node_modules
        depends_on: [ install ]

trigger:
    branch:
        - master
        - drone
    event:
        exclude:
            - cron

---
kind: pipeline
name: node-v12
type: docker

platform:
    os: linux
    arch: amd64

steps:
    -   name: restore-cache
        image: meltwater/drone-cache
        failure: ignore
        environment:
            AWS_ACCESS_KEY_ID:
                from_secret: aws_access_key_id
            AWS_SECRET_ACCESS_KEY:
                from_secret: aws_secret_access_key
            PLUGIN_PATH_STYLE: true
        settings:
            endpoint:
                from_secret: aws_endpoint
            region: ab-1
            bucket: drone-cache
            restore: true
            cache_key: '{{ checksum "package.json" }}_{{ checksum "package-lock.json" }}_node-v12'
            archive_format: gzip
            mount:
                - ./node_modules
                - ./hubot-irc/node_modules
        depends_on: [ clone ]
    -   name: install
        image: node:12
        commands:
            - node -v
            - npm -v
            - npm i --no-save --quiet --no-optional
        depends_on: [ restore-cache ]
    -   name: tests
        image: node:12
        commands:
            - npm run test
        depends_on: [ install ]
    -   name: linter
        image: node:12
        commands:
            - npm run lint
        depends_on: [ install ]
    -   name: rebuild-cache
        image: meltwater/drone-cache
        failure: ignore
        environment:
            AWS_ACCESS_KEY_ID:
                from_secret: aws_access_key_id
            AWS_SECRET_ACCESS_KEY:
                from_secret: aws_secret_access_key
            PLUGIN_PATH_STYLE: true
        settings:
            endpoint:
                from_secret: aws_endpoint
            region: ab-1
            bucket: drone-cache
            rebuild: true
            cache_key: '{{ checksum "package.json" }}_{{ checksum "package-lock.json" }}_node-v12'
            archive_format: gzip
            mount:
                - ./node_modules
                - ./hubot-irc/node_modules
        depends_on: [ install ]

trigger:
    branch:
        - master
        - drone
    event:
        exclude:
            - cron

---
kind: pipeline
name: deps
type: docker

platform:
    os: linux
    arch: amd64

steps:
    -   name: restore-cache
        image: meltwater/drone-cache
        failure: ignore
        environment:
            AWS_ACCESS_KEY_ID:
                from_secret: aws_access_key_id
            AWS_SECRET_ACCESS_KEY:
                from_secret: aws_secret_access_key
            PLUGIN_PATH_STYLE: true
        settings:
            endpoint:
                from_secret: aws_endpoint
            region: ab-1
            bucket: drone-cache
            restore: true
            cache_key: '{{ checksum "package.json" }}_{{ checksum "package-lock.json" }}_deps'
            archive_format: gzip
            mount:
                - ./node_modules
                - hubot-irc/node_modules
        depends_on: [ clone ]
    -   name: install
        image: node:12
        commands:
            - node -v
            - npm -v
            - npm i --no-save --quiet --no-optional
        depends_on: [ restore-cache ]
    -   name: audit
        image: node:12
        commands:
            - npm audit
        depends_on: [ clone ]
    -   name: outdated
        image: node:12
        commands:
            - npm run check-outdated
        depends_on: [ install ]
    -   name: rebuild-cache
        image: meltwater/drone-cache
        failure: ignore
        environment:
            AWS_ACCESS_KEY_ID:
                from_secret: aws_access_key_id
            AWS_SECRET_ACCESS_KEY:
                from_secret: aws_secret_access_key
            PLUGIN_PATH_STYLE: true
        settings:
            endpoint:
                from_secret: aws_endpoint
            region: ab-1
            bucket: drone-cache
            rebuild: true
            cache_key: '{{ checksum "package.json" }}_{{ checksum "package-lock.json" }}_deps'
            archive_format: gzip
            mount:
                - ./node_modules
                - ./hubot-irc/node_modules
        depends_on: [ install ]

trigger:
    branch:
        - master
        - drone

---
kind: signature
hmac: 92c29dc31b80844aff718f277c7163f90bd98d3b7a7b6dc029e9d7651bcf4eb4

...
